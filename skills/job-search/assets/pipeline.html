<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Search Pipeline Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1A3C6E 0%, #2d5a9e 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-top: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: white;
            color: #1A3C6E;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .kanban-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .column {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 600px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .column-header {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        .column-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cards-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #1A3C6E;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .card-company {
            font-weight: 700;
            font-size: 15px;
            color: #1A3C6E;
            margin-bottom: 5px;
        }

        .card-role {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: #718096;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .match-high {
            background: #c6f6d5;
            color: #22543d;
        }

        .match-medium {
            background: #fef5e7;
            color: #7d6608;
        }

        .match-low {
            background: #fed7d7;
            color: #742a2a;
        }

        .card-comp {
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .card-action-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-move-prev, .btn-move-next {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-move-prev:hover, .btn-move-next:hover {
            background: #cbd5e0;
        }

        .btn-delete {
            background: #fed7d7;
            color: #742a2a;
        }

        .btn-delete:hover {
            background: #fc8181;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #1A3C6E;
            font-size: 22px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #cbd5e0;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2d3748;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1A3C6E;
            box-shadow: 0 0 0 3px rgba(26, 60, 110, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-submit {
            flex: 1;
            background: #1A3C6E;
            color: white;
        }

        .btn-submit:hover {
            background: #153357;
        }

        .btn-cancel {
            flex: 1;
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        /* Expanded card modal */
        .card-detail {
            max-width: 600px;
        }

        .detail-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2d3748;
            font-size: 14px;
            line-height: 1.5;
        }

        .detail-value a {
            color: #1A3C6E;
            text-decoration: none;
            word-break: break-all;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        /* Summary section */
        .summary-section {
            background: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-top: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #1A3C6E;
            margin-bottom: 20px;
        }

        .funnel-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .funnel-item {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #1A3C6E;
        }

        .funnel-item-label {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .funnel-item-value {
            font-size: 20px;
            font-weight: 700;
            color: #1A3C6E;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #a0aec0;
        }

        /* Column colors */
        .col-discovered .column-badge { background: #3b82f6; }
        .col-researching .column-badge { background: #a855f7; }
        .col-applied .column-badge { background: #f97316; }
        .col-phonescreen .column-badge { background: #06b6d4; }
        .col-interview .column-badge { background: #4f46e5; }
        .col-offer .column-badge { background: #10b981; }
        .col-rejected .column-badge { background: #6b7280; }

        .col-discovered { border-left: 4px solid #3b82f6; }
        .col-researching { border-left: 4px solid #a855f7; }
        .col-applied { border-left: 4px solid #f97316; }
        .col-phonescreen { border-left: 4px solid #06b6d4; }
        .col-interview { border-left: 4px solid #4f46e5; }
        .col-offer { border-left: 4px solid #10b981; }
        .col-rejected { border-left: 4px solid #6b7280; }

        .card.col-discovered { border-left-color: #3b82f6; }
        .card.col-researching { border-left-color: #a855f7; }
        .card.col-applied { border-left-color: #f97316; }
        .card.col-phonescreen { border-left-color: #06b6d4; }
        .card.col-interview { border-left-color: #4f46e5; }
        .card.col-offer { border-left-color: #10b981; }
        .card.col-rejected { border-left-color: #6b7280; }

        @media (max-width: 768px) {
            .kanban-container {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Job Search Pipeline</h1>
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Active Opportunities</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Applications This Week</div>
                <div class="stat-value" id="stat-applications">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Interviews Scheduled</div>
                <div class="stat-value" id="stat-interviews">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Offers Pending</div>
                <div class="stat-value" id="stat-offers">0</div>
            </div>
        </div>
        <div class="controls">
            <button class="btn btn-primary" onclick="openAddModal()">+ Add Opportunity</button>
            <button class="btn btn-secondary" onclick="exportMarkdown()">Export as Markdown</button>
        </div>
    </div>

    <div class="kanban-container" id="kanban">
        <!-- Columns generated by JS -->
    </div>

    <div class="summary-section">
        <div class="summary-title">Pipeline Summary</div>
        <div class="funnel-chart" id="funnel">
            <!-- Funnel generated by JS -->
        </div>
        <div id="timeline-stats" style="color: #4a5568; font-size: 13px; line-height: 1.8;"></div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Opportunity</h2>
                <button class="close" onclick="closeAddModal()">&times;</button>
            </div>
            <form onsubmit="saveOpportunity(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Company *</label>
                        <input type="text" id="form-company" required>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <input type="text" id="form-role" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Compensation</label>
                        <input type="text" id="form-comp" placeholder="e.g., ₹45L or $150K">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="form-location" placeholder="e.g., Bangalore">
                    </div>
                </div>
                <div class="form-group">
                    <label>Posting URL</label>
                    <input type="url" id="form-url" placeholder="https://...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Match Score</label>
                        <select id="form-match">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stage *</label>
                        <select id="form-stage" required>
                            <option value="discovered">Discovered</option>
                            <option value="researching">Researching</option>
                            <option value="applied">Applied</option>
                            <option value="phonescreen">Phone Screen</option>
                            <option value="interview">Interview</option>
                            <option value="offer">Offer</option>
                            <option value="rejected">Declined/Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="form-notes" placeholder="Additional notes..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-submit">Add Opportunity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content card-detail">
            <div class="modal-header">
                <h2 id="detail-company"></h2>
                <button class="close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="detail-content"></div>
            <div class="modal-footer" id="detail-actions"></div>
        </div>
    </div>

    <script>
        const stages = ['discovered', 'researching', 'applied', 'phonescreen', 'interview', 'offer', 'rejected'];
        const stageLabels = {
            'discovered': 'Discovered',
            'researching': 'Researching',
            'applied': 'Applied',
            'phonescreen': 'Phone Screen',
            'interview': 'Interview',
            'offer': 'Offer',
            'rejected': 'Declined/Rejected'
        };

        // Sample data
        let opportunities = [
            { id: 1, company: 'Razorpay', role: 'Senior PM', comp: '₹48L', location: 'Bangalore', url: 'https://razorpay.com/careers', match: 'High', stage: 'offer', notes: 'Great product, strong team. Negotiating equity.', dateAdded: new Date(Date.now() - 5*24*60*60*1000) },
            { id: 2, company: 'Stripe', role: 'Product Lead', comp: '$185K', location: 'Remote', url: 'https://stripe.com/jobs', match: 'High', stage: 'interview', notes: 'Final round next week. Prepare for system design.', dateAdded: new Date(Date.now() - 7*24*60*60*1000) },
            { id: 3, company: 'Cred', role: 'PM', comp: '₹42L', location: 'Bangalore', url: 'https://cred.club/careers', match: 'Medium', stage: 'applied', notes: 'Applied 3 days ago. Waiting for response.', dateAdded: new Date(Date.now() - 3*24*60*60*1000) },
            { id: 4, company: 'Zerodha', role: 'Senior PM', comp: '₹40L', location: 'Bangalore', url: 'https://zerodha.com/careers', match: 'Medium', stage: 'discovered', notes: 'Interesting fintech opportunity. Strong engineering culture.', dateAdded: new Date() }
        ];

        let nextId = 5;
        let currentDetailId = null;

        function renderKanban() {
            const kanban = document.getElementById('kanban');
            kanban.innerHTML = '';

            stages.forEach(stage => {
                const col = document.createElement('div');
                col.className = 'column';

                const items = opportunities.filter(o => o.stage === stage);
                const colClass = 'col-' + stage;

                col.innerHTML = `
                    <div class="column-header">
                        <span class="column-badge">${items.length}</span>
                        ${stageLabels[stage]}
                    </div>
                    <div class="cards-list">
                        ${items.length === 0 ? '<div class="empty-state">No opportunities</div>' : ''}
                        ${items.map(o => `
                            <div class="card ${colClass}" onclick="openDetailModal(${o.id})">
                                <div class="card-company">${o.company}</div>
                                <div class="card-role">${o.role}</div>
                                <div class="card-meta">
                                    <span>${o.location || 'Location TBD'}</span>
                                    <span class="badge match-${o.match.toLowerCase()}">${o.match}</span>
                                </div>
                                ${o.comp ? `<div class="card-comp">${o.comp}</div>` : ''}
                                <div class="card-meta" style="color: #a0aec0; font-size: 11px;">
                                    ${formatDate(o.dateAdded)}
                                </div>
                                <div class="card-actions" onclick="event.stopPropagation()">
                                    ${stage !== 'discovered' ? `<button class="card-action-btn btn-move-prev" onclick="moveCard(${o.id}, -1)">← Prev</button>` : ''}
                                    ${stage !== 'rejected' ? `<button class="card-action-btn btn-move-next" onclick="moveCard(${o.id}, 1)">Next →</button>` : ''}
                                    <button class="card-action-btn btn-delete" onclick="deleteCard(${o.id})">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                kanban.appendChild(col);
            });
        }

        function formatDate(date) {
            const today = new Date();
            const diffTime = today - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function moveCard(id, direction) {
            const opp = opportunities.find(o => o.id === id);
            if (!opp) return;

            const currentIndex = stages.indexOf(opp.stage);
            const newIndex = currentIndex + direction;

            if (newIndex >= 0 && newIndex < stages.length) {
                opp.stage = stages[newIndex];
                renderKanban();
                updateStats();
            }
        }

        function deleteCard(id) {
            if (confirm('Are you sure you want to delete this opportunity?')) {
                opportunities = opportunities.filter(o => o.id !== id);
                renderKanban();
                updateStats();
                closeDetailModal();
            }
        }

        function openAddModal() {
            document.getElementById('addModal').style.display = 'block';
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('form-company').value = '';
            document.getElementById('form-role').value = '';
            document.getElementById('form-comp').value = '';
            document.getElementById('form-location').value = '';
            document.getElementById('form-url').value = '';
            document.getElementById('form-match').value = 'Medium';
            document.getElementById('form-stage').value = 'discovered';
            document.getElementById('form-notes').value = '';
        }

        function saveOpportunity(e) {
            e.preventDefault();
            const opp = {
                id: nextId++,
                company: document.getElementById('form-company').value,
                role: document.getElementById('form-role').value,
                comp: document.getElementById('form-comp').value,
                location: document.getElementById('form-location').value,
                url: document.getElementById('form-url').value,
                match: document.getElementById('form-match').value,
                stage: document.getElementById('form-stage').value,
                notes: document.getElementById('form-notes').value,
                dateAdded: new Date()
            };

            opportunities.push(opp);
            closeAddModal();
            renderKanban();
            updateStats();
        }

        function openDetailModal(id) {
            const opp = opportunities.find(o => o.id === id);
            if (!opp) return;

            currentDetailId = id;
            const modal = document.getElementById('detailModal');
            document.getElementById('detail-company').textContent = opp.company;

            let content = `
                <div class="detail-section">
                    <div class="detail-label">Role</div>
                    <div class="detail-value">${opp.role}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Stage</div>
                    <div class="detail-value" style="text-transform: capitalize;">${stageLabels[opp.stage]}</div>
                </div>
                ${opp.comp ? `
                <div class="detail-section">
                    <div class="detail-label">Compensation</div>
                    <div class="detail-value">${opp.comp}</div>
                </div>
                ` : ''}
                ${opp.location ? `
                <div class="detail-section">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${opp.location}</div>
                </div>
                ` : ''}
                <div class="detail-section">
                    <div class="detail-label">Match Score</div>
                    <div class="detail-value"><span class="badge match-${opp.match.toLowerCase()}">${opp.match}</span></div>
                </div>
                ${opp.url ? `
                <div class="detail-section">
                    <div class="detail-label">Posting URL</div>
                    <div class="detail-value"><a href="${opp.url}" target="_blank">View Job Posting →</a></div>
                </div>
                ` : ''}
                ${opp.notes ? `
                <div class="detail-section">
                    <div class="detail-label">Notes</div>
                    <div class="detail-value">${opp.notes.replace(/\n/g, '<br>')}</div>
                </div>
                ` : ''}
                <div class="detail-section">
                    <div class="detail-label">Date Added</div>
                    <div class="detail-value">${opp.dateAdded.toLocaleDateString()}</div>
                </div>
            `;

            document.getElementById('detail-content').innerHTML = content;

            const currentStageIdx = stages.indexOf(opp.stage);
            let actions = '';
            if (currentStageIdx > 0) {
                actions += `<button class="btn btn-secondary" onclick="moveCard(${id}, -1); closeDetailModal();">← Move to ${stageLabels[stages[currentStageIdx - 1]]}</button>`;
            }
            if (currentStageIdx < stages.length - 1) {
                actions += `<button class="btn btn-secondary" onclick="moveCard(${id}, 1); closeDetailModal();">Move to ${stageLabels[stages[currentStageIdx + 1]]} →</button>`;
            }
            actions += `<button class="btn" style="background: #fed7d7; color: #742a2a;" onclick="deleteCard(${id})">Delete</button>`;
            document.getElementById('detail-actions').innerHTML = actions;

            modal.style.display = 'block';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentDetailId = null;
        }

        function updateStats() {
            const total = opportunities.length;
            const thisWeek = opportunities.filter(o => {
                const diffTime = new Date() - o.dateAdded;
                return diffTime < 7*24*60*60*1000;
            }).length;
            const interviews = opportunities.filter(o => o.stage === 'interview' || o.stage === 'phonescreen').length;
            const offers = opportunities.filter(o => o.stage === 'offer').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-applications').textContent = thisWeek;
            document.getElementById('stat-interviews').textContent = interviews;
            document.getElementById('stat-offers').textContent = offers;

            updateFunnel();
        }

        function updateFunnel() {
            const discovered = opportunities.filter(o => o.stage === 'discovered').length;
            const applied = opportunities.filter(o => ['applied', 'phonescreen', 'interview', 'offer'].includes(o.stage)).length;
            const interview = opportunities.filter(o => ['interview', 'phonescreen'].includes(o.stage)).length;
            const offer = opportunities.filter(o => o.stage === 'offer').length;

            const convApp = discovered > 0 ? Math.round((applied / discovered) * 100) : 0;
            const convInt = applied > 0 ? Math.round((interview / applied) * 100) : 0;
            const convOff = interview > 0 ? Math.round((offer / interview) * 100) : 0;

            const funnel = document.getElementById('funnel');
            funnel.innerHTML = `
                <div class="funnel-item">
                    <div class="funnel-item-label">Discovered</div>
                    <div class="funnel-item-value">${discovered}</div>
                </div>
                <div class="funnel-item">
                    <div class="funnel-item-label">Applied (${convApp}%)</div>
                    <div class="funnel-item-value">${applied}</div>
                </div>
                <div class="funnel-item">
                    <div class="funnel-item-label">Interview (${convInt}%)</div>
                    <div class="funnel-item-value">${interview}</div>
                </div>
                <div class="funnel-item">
                    <div class="funnel-item-label">Offers (${convOff}%)</div>
                    <div class="funnel-item-value">${offer}</div>
                </div>
            `;

            const stageStats = {};
            stages.forEach(s => {
                const stageOpps = opportunities.filter(o => o.stage === s);
                if (stageOpps.length === 0) {
                    stageStats[s] = 'N/A';
                } else {
                    const avgDays = Math.round(stageOpps.reduce((sum, o) => {
                        const days = Math.floor((new Date() - o.dateAdded) / (1000*60*60*24));
                        return sum + days;
                    }, 0) / stageOpps.length);
                    stageStats[s] = avgDays + 'd';
                }
            });

            const timelineHtml = `
                <strong>Average time in each stage:</strong><br>
                ${stages.map(s => `<span style="margin-right: 20px;">${stageLabels[s]}: ${stageStats[s]}</span>`).join('')}
            `;
            document.getElementById('timeline-stats').innerHTML = timelineHtml;
        }

        function exportMarkdown() {
            let md = '# Job Search Pipeline\n\n';
            md += `Generated: ${new Date().toLocaleDateString()}\n\n`;

            md += '## Summary\n';
            md += `- Total Opportunities: ${opportunities.length}\n`;
            md += `- In Interviews: ${opportunities.filter(o => o.stage === 'interview').length}\n`;
            md += `- Offers: ${opportunities.filter(o => o.stage === 'offer').length}\n\n`;

            stages.forEach(stage => {
                const items = opportunities.filter(o => o.stage === stage);
                md += `## ${stageLabels[stage]} (${items.length})\n\n`;
                items.forEach(o => {
                    md += `### ${o.company} - ${o.role}\n`;
                    md += `- **Location:** ${o.location || 'TBD'}\n`;
                    md += `- **Compensation:** ${o.comp || 'TBD'}\n`;
                    md += `- **Match:** ${o.match}\n`;
                    md += `- **Date Added:** ${o.dateAdded.toLocaleDateString()}\n`;
                    if (o.url) md += `- **Posting:** [Link](${o.url})\n`;
                    if (o.notes) md += `- **Notes:** ${o.notes}\n`;
                    md += '\n';
                });
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'job-pipeline.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addModal');
            const detailModal = document.getElementById('detailModal');
            if (event.target === addModal) addModal.style.display = 'none';
            if (event.target === detailModal) detailModal.style.display = 'none';
        }

        // Initial render
        renderKanban();
        updateStats();
    </script>
</body>
</html>
